name: Java CI/CD with Docker

on:
  push:
    branches: [ "main" ] # main 브랜치에 push될 때 실행

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # 1. Java JDK 설정 (실무 버전인 17 혹은 21 추천)
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: gradle

    # 2. Gradle 빌드 (테스트 제외로 속도 향상, 실무에선 상황에 따라 조정)
    - name: Build with Gradle
      run: ./gradlew build -x test

    # 3. Docker Hub 로그인
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # 4. Docker 이미지 빌드 및 푸시
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ secrets.DOCKERHUB_USERNAME }}/my-backend:latest

    # 5. EC2에 접속해서 docker-compose 실행
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          cd ~/app
          # 최신 이미지 Pull
          docker-compose pull
          # 중단 없이 재시작 (변경사항이 있는 컨테이너만 교체)
          docker-compose up -d --remove-orphans
          # 미사용 이미지 삭제 (용량 관리)
          docker image prune -f
